# PRD — Telegram Intelligence Platform (MVP) — Consolidated v1.0

**Версия:** 1.0  
**Статус:** утверждено к разработке  
**Дата:** 18.09.2025  
**Автор:** Yakov Vasiliev (оркестрация соло)  

---

## Содержание
1. TL;DR
2. Контекст и проблема
3. Видение и принципы
4. Целевые пользователи и Jobs-to-be-Done
5. Цели и метрики успеха (North Star / SLO/SLI)
6. Скоуп MVP
   - 6.1 Что входит (user stories)
   - 6.2 Что не входит
7. Нефункциональные требования
8. Архитектура (логическая и физическая)
9. Данные и модель БД
10. API-контракты (эталонные эндпоинты)
11. UX-флоу и интерфейс (минимальный)
12. Наблюдаемость и мониторинг
13. Риски и план митигации
14. План внедрения и майлстоуны
15. Бюджет и оценка затрат
16. Открытые вопросы и допущения
17. Приложения (решения по стеку, конкурентный фон)

---

## 1. TL;DR
**Telegram Intelligence Platform** — утилитарный SaaS‑инструмент для **добавления каналов, автоматического сбора постов и мгновенной фильтрации по ключевым словам** с опциональными **AI‑саммари** для длинных сообщений. MVP оптимизирован под **быстрый выпуск (≤3 недель)**, минимальный стек и последующий переход к полноценной мультипользовательской архитектуре.

---

## 2. Контекст и проблема
- Telegram — важный источник новостных и экспертных сигналов. Ручной мониторинг десятков каналов превращается в «скроллинг‑ад» и ведет к **пропуску значимого** и **перегрузке временем**.
- Нужен инструмент «подсетки»: быстро добавить каналы, регулярно собирать сообщения, **искать по тексту без латентности**, получать суть длинных постов.

---

## 3. Видение и принципы
1. **Прагматичный MVP**: только то, что дает ценность сейчас.  
2. **Простота стека**: управляемые сервисы, минимум DevOps.  
3. **Готовность к росту**: с первых строк кода закладываем индексацию текста и стратегию rate‑limit.  
4. **Этика и право**: явные границы по данным и юрисдикциям, прозрачность использования.

---

## 4. Целевые пользователи и Jobs-to-be-Done
- **Стратег/аналитик/редактор**: «Я хочу **быстро найти** релевантные упоминания и выдержки, **не читая всё**».  
- **PR/коммс**: «Я хочу **отслеживать темы/упоминания брендов** и собирать выдержки для дайджестов».  
- **OSINT‑исследователь**: «Я хочу **регулярно тянуть** контент из списка каналов, **фильтровать** и **архивировать**.

**JTBD‑формула:** когда появляется поток новых постов в подключенных каналах, я хочу мгновенно отфильтровать по ключевой фразе и увидеть краткое саммари, чтобы решить читать полностью или отложить.

---

## 5. Цели и метрики успеха (North Star / SLO/SLI)
**Пользовательские цели**
1. Сократить время мониторинга **с часов до минут**.  
2. Получать **краткую суть** длинных постов (AI‑саммари) там, где это целесообразно.  

**Бизнес‑цели MVP**
1. Проверить востребованность и собрать **качественный фидбек** от первых 5–10 активных пользователей.  
2. Сформировать базу для дальнейшего SaaS‑масштабирования.  

**Метрики успеха на 1‑й месяц после запуска**
1. **Готовность к запуску** ≤ 3 недель.  
2. **Доля успешно обработанных постов** > 95% на пуле 50+ активных каналов.  
3. **Вовлечённость**: ≥ 5 пользователей с частотой ≥ 3 сессии/нед.  
4. **Подтвержденная ценность AI‑саммари**: ≥ 2 качественных отзыва.  

**SLO/SLI (операционные целевые уровни)**
- **Средняя задержка появления поста** в индексе: < 30 сек (warm‑режим) / < 5 мин (batch‑режим).  
- **Частота FLOOD_WAIT**: < 1% запросов/сутки.  
- **Жизненный цикл сессии**: > 30 дней без блокировки.  

---

## 6. Скоуп MVP
### 6.1. Что входит (user stories)
1. **Добавление канала** по URL `t.me/<name>` (валидация и первичная загрузка истории N=200 сообщений).  
2. **Список каналов** со статусами («Активен», «Ошибка парсинга», «Обновляется…»).  
3. **Просмотр постов канала** (последние N=200 с пагинацией).  
4. **Фильтр по ключевому слову/фразе** (поиск по тексту поста).  
5. **AI‑саммари** для длинных постов (> 500 символов), хранение и кэширование результата.  

### 6.2. Что не входит (сознательно)
- Авторизация и мультиаккаунтность.  
- Тарифы, оплата.  
- Сложная аналитика/дашборды, тональность, фасеты.  
- Оповещения (email/бот), экспорт данных.  
- Приватные каналы и чаты.  

---

## 7. Нефункциональные требования
1. **Производительность**: фильтр по ключу — P95 ≤ 300 мс на 50k–200k постов при наличии GIN‑индексов.  
2. **Надежность**: graceful‑restarter, повтор запросов с экспоненциальной задержкой, circuit‑breaker к внешним сервисам.  
3. **Безопасность**: безопасное хранение `.session` для MTProto, секретов и прокси; ограничение экспортных функций.  
4. **Право/соответствие**: явная политика данных, режимы локализации, исключение персональных данных; акцент на открытые публичные каналы.  

---

## 8. Архитектура (логическая и физическая)
**Стек (MVP):**
- **Frontend**: Next.js + TypeScript + Tailwind + shadcn/ui (деплой: Vercel).  
- **Backend**: FastAPI (Python) + Telethon для MTProto; APScheduler для фоновых задач (деплой: Railway).  
- **База**: PostgreSQL (Supabase) с **Full‑Text Search** и **GIN**‑индексами.  
- **AI‑сервис**: отдельный лёгкий FastAPI с моделью саммаризации (Replicate / HF Inference).  
- **(Опционально)**: Redis для очередей/троттлинга; прокси‑ротация на residential IP для устойчивости.  

**Паттерн обработки (гибрид):**
```
[Telegram Updates / Batch Pull]
           ↓
     [Message Queue]*
           ↓
       [FastAPI]
           ↓
      [PostgreSQL]
      ↙         ↘
 [AI Summaries]  [Cache]
```
\* На первом этапе можно обойтись без внешней очереди, используя APScheduler и аккуратный rate‑limit.  

**Real‑time vs Batch:**
- **Warm (real‑time)**: постоянное подключение к MTProto и `client.run_until_disconnected()` для минимальной задержки.  
- **Batch (первый запуск/ресурсный режим)**: фоновая выборка новых постов каждые N минут.

**Стратегия rate‑limit и сессий**
- Пул из 1–2 аккаунтов (Premium при росте) и 2–3 сессий каждый; умные задержки; журнал FLOOD_WAIT.  
- Ротация прокси; «разогрев» аккаунтов с постепенным ростом нагрузки.  

---

## 9. Данные и модель БД
**Сущности**: `channels`, `posts`, `summaries`, `fetch_jobs`.

**DDL (эталон):**
```sql
create table channels (
  id bigserial primary key,
  tg_url text not null unique,
  tg_id bigint,
  title text,
  status text not null default 'active',
  created_at timestamptz default now()
);

create table posts (
  id bigserial primary key,
  channel_id bigint not null references channels(id) on delete cascade,
  tg_message_id bigint not null,
  posted_at timestamptz,
  text text,
  raw jsonb,
  created_at timestamptz default now(),
  unique(channel_id, tg_message_id)
);

-- полнотекстовый поиск
alter table posts add column text_tsv tsvector;
create index idx_posts_tsv on posts using gin (text_tsv);
create index idx_posts_posted_at on posts(posted_at desc);

create table summaries (
  post_id bigint primary key references posts(id) on delete cascade,
  model text not null,
  summary text not null,
  created_at timestamptz default now()
);

create table fetch_jobs (
  id bigserial primary key,
  channel_id bigint not null references channels(id) on delete cascade,
  started_at timestamptz default now(),
  finished_at timestamptz,
  status text not null default 'running',
  stats jsonb
);

-- обновление tsvector
create or replace function posts_tsv_update() returns trigger as $$
begin
  new.text_tsv := to_tsvector('simple', coalesce(new.text,''));
  return new;
end; $$ language plpgsql;

create trigger posts_tsv_trg before insert or update of text on posts
for each row execute function posts_tsv_update();
```

---

## 10. API-контракты (эталон)
**Добавить канал**  
`POST /api/channels`  
```json
{
  "tg_url": "https://t.me/example_channel"
}
```
**Ответ:** `201 Created` + объект канала.

**Список каналов**  
`GET /api/channels`

**Посты канала**  
`GET /api/channels/{id}/posts?query=keyword&page=1&page_size=50`

**Саммаризировать пост**  
`POST /api/posts/{post_id}/summarize`
```json
{
  "model": "replicate/your-model:latest"
}
```

**Схема ошибок** (единая)  
```json
{
  "error": {
    "code": "RATE_LIMIT",
    "message": "Flood wait 17s",
    "retry_in_sec": 17
  }
}
```

---

## 11. UX-флоу и интерфейс (минимальный)
1. **Главный экран**: таблица каналов (название, статус, последняя синхронизация), кнопка «Добавить канал».  
2. **Добавление**: модалка с валидацией URL, прогресс первичной загрузки.  
3. **Экран канала**: лента постов (карточки или табличный список), строка поиска, пагинация.  
4. **AI‑саммари**: блок «Краткая суть» у длинных постов, возможность открыть оригинал.  
5. **Empty states**: дружественные подсказки по добавлению первого канала и поиску.  

Компонентная база: shadcn/ui (Input, Table, Badge, Dialog, Toast, Skeleton для загрузки).  

---

## 12. Наблюдаемость и мониторинг
**Метрики** (Prometheus/OTel + простая метрика в БД):
- ingest_success_ratio, ingest_latency_p50/p95, flood_wait_rate, sessions_alive, proxy_errors.  
- API p95 latency, db_query_time, summarize_cost_per_1k_chars.  

**Алерты**:
- ingest_success_ratio < 0.9 за 15 мин.  
- flood_wait_rate > 3% за час.  
- sessions_alive == 0.  

---

## 13. Риски и план митигации
1. **Блокировка/бан аккаунтов**: выделенные аккаунты, «разогрев», прокси‑ротация, умные задержки.  
2. **Стоимость AI**: кэширование саммари, лимиты длины текста, «саммари по требованию».  
3. **Bus‑factor = 1**: простой стек, документация кода, автоматизация деплоя.  
4. **Производительность при росте**: индексы, переход к очередям и Celery/Redis при необходимости, горизонтальное масштабирование бекенда.  
5. **Право/юрисдикция**: публичные источники, консультирование по локализации данных, режим «western residency».  

---

## 14. План внедрения и майлстоуны
**Неделя 0 (19–22.09): проектирование**  
- Финализация схемы БД и API‑контрактов.  
- Вайрфреймы интерфейса.  
- Подготовка окружений (Vercel/Railway/Supabase).  

**Неделя 1 (23–29.09): backend**  
- Модели и миграции БД.  
- Telethon‑парсер (история + новые).  
- API для каналов/постов.  
- APScheduler задачи.  

**Неделя 2 (30.09–06.10): frontend**  
- Компоненты shadcn/ui, экраны.  
- Интеграция с API, фильтр.  

**Неделя 3 (07–13.10): AI и запуск**  
- Развертывание модели саммаризации.  
- E2E‑тесты, отладка.  
- Финальный деплой и первые тестеры.

---

## 15. Бюджет и оценка затрат (MVP)
- Месяцы 1–3: 0–25 $/мес (бесплатные тарифы управляемых сервисов).  
- Рост: 50–100 $/мес.  
- Масштабирование: 200–500 $/мес (очереди, выделенные инстансы, хранилище).  

---

## 16. Открытые вопросы и допущения
**Допущения:** публичные каналы, умеренный объем данных (≤ 200k постов), отсутствует авторизация.  
**Вопросы:**
1. Какие юрисдикции хранения и ЦА (ЕС/США)?  
2. Нужен ли ограниченный гостевой доступ для внешних тестеров?  
3. Какой лимит длины для саммаризации и модель‑по‑умолчанию?  

---

## 17. Приложения
- **Решение по стеку**: FastAPI + Telethon, PostgreSQL FTS (GIN), Next.js + shadcn/ui, управляемые деплои Vercel/Railway, AI‑саммари (Replicate/HF).  
- **Конкурентный фон**: специализированные Telegram‑мониторинги обрабатывают десятки миллионов постов/сутки; наша цель — уверенный MVP на тысячи/десятки тысяч постов с минимальной задержкой.

---

### Чек‑лист перехода к архитектуре (handoff)
1. DDL/миграции готовы и проверены локально.  
2. Описаны API‑эндпоинты и статусы ошибок.  
3. Сформирован .env.example (секреты, прокси, лимиты).  
4. Решен режим запуска (warm vs batch) и частота задач.  
5. Гайд по развертыванию: Vercel + Railway + Supabase.  
6. Базовые алерты и логирование включены.  

— Конец PRD —